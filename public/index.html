<!DOCTYPE html>
<html>
<head>
    <title>Realtime Blog</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="container mt-4">
    <div id="auth-section">
        <h3>Đăng nhập / Đăng ký</h3>
        <input id="user" class="form-control mb-2" placeholder="Username">
        <input id="pass" type="password" class="form-control mb-2" placeholder="Password">
        <button class="btn btn-primary" onclick="login()">Vào Blog</button>
        <!-- Thêm nút này -->
        <button class="btn btn-outline-secondary" onclick="register()">Đăng ký tài khoản</button>
    </div>

    <div id="blog-section" style="display:none">
        <h2>Viết bài mới</h2>
        <input id="title" class="form-control mb-2" placeholder="Tiêu đề">
        <textarea id="content" class="form-control mb-2" placeholder="Nội dung"></textarea>
        <button class="btn btn-success" onclick="createPost()">Đăng bài</button>
        <hr>
        <div id="posts"></div>
    </div>

    <script>
        const socket = io();
        let token = "";

        // --- HÀM ĐĂNG KÝ MỚI ---
        async function register() {
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user.value, password: pass.value})
            });
            if (res.ok) {
                alert("Đăng ký thành công! Giờ bạn có thể đăng nhập.");
            } else {
                alert("Lỗi đăng ký (có thể tên user đã tồn tại)");
            }
        }

        async function login() {
            const res = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user.value, password: pass.value})
            });
            if (res.ok) {
                const data = await res.json();
                token = data.token;
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('blog-section').style.display = 'block';
                loadPosts();
            } else { alert("Sai thông tin!"); }
        }

        async function loadPosts() {
            const res = await fetch('/posts');
            const posts = await res.json();
            posts.forEach(addPostToUI);
        }

        async function createPost() {
            await fetch('/posts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: title.value, content: content.value})
            });
        }

        function addPostToUI(post) {
            const div = document.createElement('div');
            div.className = "card mb-3 p-3";
            div.innerHTML = `<h4>${post.title}</h4><p>${post.content}</p>
                             <div id="cmts-${post.id}" class="ms-4 border-start ps-2"></div>
                             <input id="in-${post.id}" class="form-control mt-2" placeholder="Viết bình luận...">
                             <button onclick="sendCmt(${post.id})" class="btn btn-sm btn-link">Gửi</button>`;
            document.getElementById('posts').prepend(div);
            loadComments(post.id);
        }

        async function loadComments(postId) {
            const res = await fetch('/comments/' + postId);
            const cmts = await res.json();
            cmts.forEach(addCmtToUI);
        }

        async function sendCmt(postId) {
            const input = document.getElementById('in-' + postId);
            await fetch('/comments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({post_id: postId, content: input.value})
            });
            input.value = "";
        }

        function addCmtToUI(cmt) {
            const area = document.getElementById('cmts-' + cmt.post_id);
            if(area) area.innerHTML += `<div class="small text-muted">- ${cmt.content}</div>`;
        }

        // LẮNG NGHE REALTIME
        socket.on('new_post', (post) => addPostToUI(post));
        socket.on('new_comment', (cmt) => addCmtToUI(cmt));
    </script>
</body>
</html>