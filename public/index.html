<!DOCTYPE html>
<html>
<head>
    <title>Realtime Blog</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- THAY ĐỔI: Dùng CDN để chạy được trên Vercel -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="container mt-4">
    <!-- (Giữ nguyên các thẻ HTML div auth-section và blog-section của bạn) -->
    <div id="auth-section">
        <h3>Đăng nhập / Đăng ký</h3>
        <input id="user" class="form-control mb-2" placeholder="Username">
        <input id="pass" type="password" class="form-control mb-2" placeholder="Password">
        <button class="btn btn-primary" onclick="login()">Vào Blog</button>
        <button class="btn btn-outline-secondary" onclick="register()">Đăng ký tài khoản</button>
    </div>

    <div id="blog-section" style="display:none">
        <h2>Viết bài mới</h2>
        <input id="title" class="form-control mb-2" placeholder="Tiêu đề">
        <textarea id="content" class="form-control mb-2" placeholder="Nội dung"></textarea>
        <button class="btn btn-success" onclick="createPost()">Đăng bài</button>
        <hr>
        <div id="posts"></div>
    </div>

    <script>
        // PHÂN ĐỊNH MÔI TRƯỜNG CHI TIẾT
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        const BACKEND_URL = isLocal 
            ? 'http://localhost:3000' 
            : 'https://robert-s-blog.onrender.com'; // CHÚ Ý: Thay link Render của bạn vào đây

        // Kết nối socket với URL đã phân định
        const socket = io(BACKEND_URL);
        let token = "";

        // TẤT CẢ CÁC HÀM FETCH ĐỀU DÙNG BACKEND_URL
        async function register() {
            const res = await fetch(`${BACKEND_URL}/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user.value, password: pass.value})
            });
            alert(res.ok ? "Đăng ký xong!" : "Lỗi đăng ký");
        }

        async function login() {
            const res = await fetch(`${BACKEND_URL}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user.value, password: pass.value})
            });
            if (res.ok) {
                const data = await res.json();
                token = data.token;
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('blog-section').style.display = 'block';
                loadPosts();
            } else { alert("Sai thông tin!"); }
        }

        async function loadPosts() {
            const res = await fetch(`${BACKEND_URL}/posts`);
            const posts = await res.json();
            document.getElementById('posts').innerHTML = ""; // Clear để tránh lặp bài khi load lại
            posts.forEach(addPostToUI);
        }

        async function createPost() {
            await fetch(`${BACKEND_URL}/posts`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: title.value, content: content.value})
            });
        }

        async function loadComments(postId) {
            const res = await fetch(`${BACKEND_URL}/comments/` + postId);
            const cmts = await res.json();
            cmts.forEach(addCmtToUI);
        }

        async function sendCmt(postId) {
            const input = document.getElementById('in-' + postId);
            await fetch(`${BACKEND_URL}/comments`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({post_id: postId, content: input.value})
            });
            input.value = "";
        }

        function addPostToUI(post) {
            const div = document.createElement('div');
            div.className = "card mb-3 p-3";
            div.innerHTML = `<h4>${post.title}</h4><p>${post.content}</p>
                             <div id="cmts-${post.id}" class="ms-4 border-start ps-2"></div>
                             <input id="in-${post.id}" class="form-control mt-2" placeholder="Viết bình luận...">
                             <button onclick="sendCmt(${post.id})" class="btn btn-sm btn-link">Gửi</button>`;
            document.getElementById('posts').prepend(div);
            loadComments(post.id);
        }

        function addCmtToUI(cmt) {
            const area = document.getElementById('cmts-' + cmt.post_id);
            if(area) area.innerHTML += `<div class="small text-muted">- ${cmt.content}</div>`;
        }

        socket.on('new_post', (post) => addPostToUI(post));
        socket.on('new_comment', (cmt) => addCmtToUI(cmt));
    </script>
</body>
</html>